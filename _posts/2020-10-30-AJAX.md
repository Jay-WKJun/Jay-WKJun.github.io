---
layout: post
title: Asynchronous
tags: [JavaScript, AJAX, Theories]
excerpt_separator: <!--more-->
---

# Asynchronous

í•˜ë‚˜ì˜ ì½”ë“œì˜ íë¦„ê³¼ëŠ” ë³„ê°œì˜ ì½”ë“œì˜ íë¦„ì„ ë§Œë“¤ì–´ ì—¬ëŸ¬ê°€ì§€ ì‘ì—…ì„ ë™ì‹œì— í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ê²ƒ.

ì¢‹ì€ serviceë¥¼ ìœ„í•´ì„  í•„ìˆ˜ì ì´ë‹¤.

<!--more-->

# AJAX

Asynchronous Javascript And Xmlì˜ ì•½ì

Allows us to communicate with remote web server in an asynchronous way. with AJAX calls, we can request data from web service dynamically.

# API?

Application Programming Interface

Piece of software that can be used by another piece of software, in order to allow applications to talk to each other

# Promises

Definition : An object that is used as a placeholder for the future result of an asynchronous operation (A container for an asynchronously delivered value, A container for a future value)

ì—¬ê¸°ì„œ future value = Response from AJAX call ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤.

Callback function ë“¤ì´ ê²¹ê²¹íˆ ìŒ“ì—¬ Callback Hellì´ ë˜ëŠ”ê²ƒì„ í•´ê²°í•´ì£¼ëŠ” ES6ì—ì„œ ì¶”ê°€ëœ ê¸°ëŠ¥ì´ë‹¤.

## Callback Hell?

```javascript
//"Callback Hell"
//cascadeí•˜ê²Œ functionì´ í•œë²ˆì— ëª¨ë‘ ì‹¤í–‰ë˜ì–´ì•¼ í•  ë•Œ ì´ë ‡ê²Œ ì„¤ê³„í•œë‹¤.
function f1(){
    function f2(){
        function f3(){

        }
    }
}
```

## Promiseì˜ ì¥ì 

We no longer need to rely on events and callbacks passed into asynchronous functions to handle asynchronous results

Instead of nesting callbacks, we can chain promises for a sequence of asynchronous operations: escaping callback hell

## Promise Lifecycle

Promises is only settled once! (Fullfilled or Rejected)

![PromiseLifeCycle]({{ "/assets/img/aboutJavaScript/PromisesLifeCycle.PNG" | relative_url }})

## Let's Implement Promises

Callback Chainë³´ë‹¤ ì§ê´€ì ì´ê³  ì½ê¸° ì‰½ë‹¤.

```javascript
//í•˜ë‚˜ì˜ promiseê°€ ëë‚˜ê³  ë‹¤ë¥¸ promiseë¥¼ ì‹¤í–‰
//ë”°ë¼ì„œ aka. "flat chain"
const getCountryData = function (country) {
    //country 1
    fetch('https://restcountries.eu/rest/v2/name/${country}')
        .then(response => response.json())
        .then(data => {
            renderCounrty(data[0]);
            const neighbour = data[0].borders[0];

            if (!neighbour) return;

            //country 2
            return fetch('https://restcountries.eu/rest/v2/name/${neighbour}');

            // ì•ˆì¢‹ì€ ì˜ˆ Promiseì•ˆì— Promiseê°€ ë˜ë¯€ë¡œ callback hellì— í•´ë‹¹í•œë‹¤.
            //fetch('https://restcountries.eu/rest/v2/name/${neighbour}').then(response => response.json())
        })
        .then(response => response.json());
        .then(data => renderCountry(data, 'neighbour'));
}

getCounrtyData('portugal');
```

# Handle Rejected Promises (Handle Errors)

1. then methodì˜ 2ë²ˆì§¸ parameterì— error handle callback function implement
2. catch functionì„ chain ì•ˆì— ì¶”ê°€í•œë‹¤. promiseê°€ rejectedì´ë©´ ì–´ë””ì„œ errorê°€ ë°œìƒí•˜ë“  ë°œë™í•˜ëŠ” ê²ƒì´ íŠ¹ì§•

javaì˜ try...catch...finallyì™€ ìœ ì‚¬í•˜ë‹¤.

```javascript
const getCountryData = function (country) {
    //country 1
    fetch('https://restcountries.eu/rest/v2/name/${country}')

        
        .then(response => {
            console.log(response);

            //How to Throw Error Manually no.1
            if(!response.ok)
                //Throwì‹œì— í˜„ì¬ methodê°€ ë°”ë¡œ ì¢…ë£Œí•˜ê³  Rejected promiseë¥¼ return = catch method ë°œë™
                throw new Error('Country not found ${response.status}');

            return response.json()}, 
        //How to catch Err no.1
        //then methodì— ë‘ë²ˆì§¸ parameterì¶”ê°€í•˜ê¸°
        err => alert(err))
        .then(data => {
            renderCounrty(data[0]);
            const neighbour = data[0].borders[0];

            if (!neighbour) return;

            //country 2
            //chaining promise
            return fetch('https://restcountries.eu/rest/v2/name/${neighbour}');
        })
        .then(response => response.json());
        .then(data => renderCountry(data, 'neighbour'));

        //How to catch Err no.2
        //errì—ëŠ” JS built-in error objectê°€ ë“¤ì–´ì˜¨ë‹¤.
        .catch(err => {
            console.error('${err} !!!!!!!');
            alert('${err.message}');
        });

        //Promiseê°€ fullfilledì´ê±´ rejectì´ê±´ ë°˜ë“œì‹œ ë°œë™í•˜ëŠ” method
        .finally(() => {
            
        })
}

getCounrtyData('portugal');
```
# How Asyncronous works behind the scene???

Runtime? : ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ëª¨ë“  ë¶€í’ˆë“¤ì˜ ëª¨ì„ ì¦‰, ì‹¤í–‰í™˜ê²½

![JSRuntimeInBrowser]({{ "/assets/img/aboutJavaScript/JSRuntimeInBrowser.PNG" | relative_url }})

JS engine = Heap + Call stack

Heap : Where Objects are stored in memory

Call stack : Where code is actually executed, Only ONE!!!! thread of execution. NO Multitasking!!

Web APIs : APIs provided to the engine, JSì˜ íŒŒíŠ¸ê°€ ì•„ë‹ˆë‹¤. (DOM, Fetch API, Timers, Geolocation API ë“±ë“±...)

Callback Queue : Ready-to-be-executed callback functions(coming from events)

Event Loop : When 'Call stack' is empty, event loop takes callbacks from the callback queue and puts them into call stack so that they can be executed, Asyncronousí•˜ê²Œ ì›€ì§ì´ë„ë¡ í•˜ëŠ”ë°ì— í•µì‹¬ì´ë‹¤.

## JSì—”ì§„ì€ Single Threadì¸ë° ì–´ë–»ê²Œ Asyncronousí•˜ê²Œ ì›€ì§ì¼ ìˆ˜ ìˆì§€?

web API, callback queue(or microtasks queue), event loopê°€ Asyncë¥¼ ê°€ëŠ¥í•˜ê²Œ í•´ì¤€ë‹¤.

call stack ì´ì™¸ì— Fetch(), setTimeOut(), DOM() ë“±ì„ ì œê³µí•˜ëŠ” webAPIsì—ì„œ ê°œë³„ì ìœ¼ë¡œ ì²˜ë¦¬ê°€ ì§„í–‰ì´ ëœë‹¤. (DOMì€ Asyncí•˜ê²Œ ì›€ì§ì´ì§€ ì•Šê³  ë°”ë¡œ callback queueì— ì¶”ê°€ëœë‹¤.)

ë§Œì•½ image loadì²˜ë¦¬ê°€ ìˆë‹¤ê³  ê°€ì •í•œë‹¤ë©´, image loadê°€ ëë‚˜ë©´ load eventê°€ ë°œë™ë˜ê³  ì´ë¥¼ í†µí•´ callback queueì— ì¶”ê°€ ëœë‹¤.

callback queueì—ì„œ ìˆœì„œë¥¼ ê¸°ë‹¤ë¦¬ê³  call stackì— ì‹¤í–‰ë˜ê³  ìˆëŠ” ì½”ë“œê°€ ì—†ë‹¤ë©´

Event Loopë¥¼ í†µí•´ image load ì´ë²¤íŠ¸ê°€ callback queueì—ì„œ call stackìœ¼ë¡œ ì˜¬ë¼ê°€ ì‹¤í–‰ëœë‹¤.(aka. "Event Loop tick")

ì¦‰, Event loopê°€ ì–´ë–¤ ì½”ë“œë¥¼ ì‹¤í–‰ì‹œí‚¬ì§€ ì •í•˜ê¸° ë•Œë¬¸ì— Asyncí™˜ê²½ì„ ë§Œë“œëŠ”ë° ê°€ì¥ ì¤‘ìš”í•˜ë‹¤.

- promise

promiseëŠ” ì¼ë°˜ eventì™€ëŠ” ì¡°ê¸ˆ ë‹¤ë¥´ë‹¤.

promiseë“¤ì€ callback queueê°€ ì•„ë‹Œ microtasks queueë¥¼ ì‚¬ìš©í•˜ë©° callback queueë³´ë‹¤ ìš°ì„  ì‹¤í–‰ëœë‹¤.

```javascript
//1
console.log('Test start');
//2
setTimeout(() => console.log('0 sec timer'), 0);
//3
//Promiseë¥¼ ë§Œë“¤ì–´ ì¦‰ì‹œ resolveí•œë‹¤.
Promise.resolve('Resolved promise 1').then(res => console.log(res)); //expecting result : "Resolved promise 1"

//4
Promise.resolve('Resolved promise 2').then(res => {
    for (let i = 0; i < 10000000000; i++) {}
    console.log(res);
}); //expecting result : "Resolved promise 1"
//5
console.log('Test end');

//ì¶œë ¥ ìˆœì„œ 1 -> 4 -> 3 -> 2
//call backì´ì™¸ì˜ codeë“¤ì´ ê°€ì¥ ë¨¼ì € ì‹¤í–‰ëœë‹¤. Synchronousí•œ 1,5ê°€ ê°€ì¥ ë¨¼ì € ì‹¤í–‰ëœë‹¤.
//promiseëŠ” microtasks queueë¡œ ì¸í•´ ê°€ì¥ ë¨¼ì € ì‹¤í–‰ëœë‹¤. ë”°ë¼ì„œ 3,4
//callback queueì— í•´ë‹¹í•˜ëŠ” 2ëŠ” ê°€ì¥ ë§ˆì§€ë§‰
```

# Promise

JSì˜ íŠ¹ë³„í•œ Objectì¸ Promiseì— ëŒ€í•´

## constructor

promiseì˜ constructorëŠ” ì˜¤ì§ í•˜ë‚˜ì˜ argumentë§Œ ë°›ëŠ”ë‹¤

aka. "executor function"

## encapsulate other async behavior

```javascript
//aka. executor function
const lotteryPromise = new Promise(function(resolve, reject){
    console.log('Lottery draw is happening');
    
    //setTimeoutì„ promiseì•ˆì— ë„£ì–´ì„œ ì¼ë°˜ callback functionì„ promiseë¡œ ë‹¤ë£¨ë„ë¡ í•˜ì˜€ë‹¤.
    //ë‹¤ë¥¸ Asynchronous behavior ë˜í•œ ì´ë ‡ê²Œ promiseì•ˆì— encapsulateí•  ìˆ˜ ìˆë‹¤. aka.promisifying
    setTimeout(function(){
        if(Math.random() >= 0.5){
            //when it's fullfilled(aka. resolve promise)
            //resolve functionì´ return í•˜ëŠ” ê²ƒì´ í›—ë‚  then methodê°€ ë°›ëŠ” parameterê°€ ëœë‹¤.
            resolve('YOU WIN!!!!!!');
        }else{
            //when it's rejected
            //catch handlerê°€ ì´ methodë¥¼ í†µí•´ ì „ë‹¬ë˜ì–´ ì‹¤í–‰ëœë‹¤.
            reject(new Error('YOU LOST.......... your money'));
        }
    }, 2000)
})

//ì´ë ‡ê²Œ callback based asyncí”„ë¡œì„¸ìŠ¤ë¥¼ promise based asyncë¡œ í•˜ëŠ”ê²ƒì„ 'promisifying'ì´ë¼ê³  í•œë‹¤
lotteryPromise
.then(res => console.log(res))
.catch(err => console.error(err));

//Promisifying setTimeout (ì›ë˜ setTimeoutì€ ì¼ë°˜ callback functionì´ë‹¤)
const wait = function(seconds){
    //timerëŠ” ì‹¤íŒ¨í•  ìˆ˜ê°€ ì—†ìœ¼ë¯€ë¡œ rejectedëŠ” ì•ˆí•´ì¤˜ë„ ëœë‹¤.
    return new Promise(function(resolve){
        setTimeout(resolve, seconds * 1000);
    });
};

wait(2).then(() => {
    console.log('I waited for 2 seconds');
    //í•˜ë‚˜ì˜ promiseê°€ ì§„í–‰ë˜ê³  ì—°ì†ìœ¼ë¡œ promiseë¥¼ ì‹¤í–‰ ì‹œí‚¨ë‹¤.`
    return wait(1);
}).then(() => console.log('I waited for 1 seconds'));
```

# Consuming Proromises with Async/Await (ìƒˆë¡œìš´ ë¬¸ë²•)

ES2017ì— ì¶”ê°€ ëœ ìƒˆë¡œìš´ ë¬¸ë²•ì´ë‹¤. classì²˜ëŸ¼ ë¬¸ë²•ë§Œ ë°”ë€ê±°ê³  ë’¤ì˜ ì²˜ë¦¬ëŠ” promiseì™€ ê°™ë‹¤.

Synthtic sugar!

```javascript
//ìƒˆë¡œìš´ ë¬¸ë²•ìœ¼ë¡œ ë˜‘ê°™ì€ ì²˜ë¦¬ë¥¼ ë‹¤ì‹œ ì”€
const whereAmI = async function () {
  //err handle : .catchê°€ ì—†ê¸° ë•Œë¬¸ì— ê³ ì „ ë¬¸ë²•ì¸ try catchë¥¼ ì‚¬ìš©í•´ error handle
  try {
    /*  ì„¤ëª…
    : ìƒˆë¡œìš´ ë¬¸ë²•ì„ í†µí•´ ì—¬ëŸ¬ê°œì˜ returnì„ í•„ìš”ë¡œ í•˜ì§€ ì•Šì•„ ê¹”ë”í•˜ë‹¤.
    : í•˜ë‚˜ì˜ single streamì²˜ëŸ¼ í‘œí˜„í•  ìˆ˜ ìˆì–´ ê°€ë…ì„± up

        async : í•´ë‹¹ functionì´ main threadì™€ëŠ” ë‹¤ë¥¸ streamì´ë¼ëŠ” ê²ƒì„ ì •í•´ì£¼ëŠ” ê²ƒìœ¼ë¡œ
            main streamì„ blockí•˜ì§€ ì•Šê³  ë³„ê°œì˜ streamìœ¼ë¡œ ì²˜ë¦¬ê°€ ì´ë£¨ì–´ì§„ë‹¤.
        await : í•´ë‹¹ functionì´ returní• ë•Œê¹Œì§€ ëŒ€ê¸°!
            functionì˜ ê²°ê³¼ê°’ì´ ë‹¤ìŒë²ˆ ì²˜ë¦¬ì— í•„ìš”í• ë•Œ ê±¸ì–´ì£¼ëŠ” ê²ƒ.
    */

    // Geolocation
    const pos = await getPosition();
    const { latitude: lat, longitude: lng } = pos.coords;

    // Reverse geocoding
    const resGeo = await fetch(`https://geocode.xyz/${lat},${lng}?geoit=json`);
    if (!resGeo.ok) throw new Error('Problem getting location data');

    const dataGeo = await resGeo.json();
    console.log(dataGeo);

    // Country data
    const res = await fetch(
      `https://restcountries.eu/rest/v2/name/${dataGeo.country}`
    );
    if (!resGeo.ok) throw new Error('Problem getting country');

    const data = await res.json();
    console.log(data);
    renderCountry(data[0]);

    // Async function return
    return `You are in ${dataGeo.city}, ${dataGeo.country}`;
  } catch (err) {
    console.error(`${err} ğŸ’¥`);
    renderError(`ğŸ’¥ ${err.message}`);

    // Reject promise returned from async function
    throw err;
  }
};
whereAmI();

/*
    * async functionì˜ return
    - ë”°ë¡œ catchì•ˆì— throwë¥¼ ì„¤ì •í•´ì£¼ì§€ ì•Šìœ¼ë©´ ëª¨ë‘ fullfilled valueë¡œì„œ returnëœë‹¤.
    
    * main threadì²˜ë¦¬ì— asyncì˜ returnì´ í•„ìš”í•œ ê²½ìš°
    - async functionì´ return ë  ë•Œê¹Œì§€ ë©ˆì¶°ìˆëŠ”ë‹¤.
    ex) 
    console.log('1')
    const city = whereAmI();
    console.log(city)
    console.log('3')
    ì¶œë ¥ : 1 -> Promise -> 3
*/

// ìœ„ ì•„ë˜ê°€ ê°™ì€ ì²˜ë¦¬ì´ë‹¤.(ë¬¸ë²•ë§Œ ë‹¤ë¥´ê²Œ í•¨)
// whereAmI()
//   .then(city => console.log(`2: ${city}`))
//   .catch(err => console.error(`2: ${err.message} ğŸ’¥`))
//   .finally(() => console.log('3: Finished getting location'));

(async function () {
  try {
    const city = await whereAmI();
    console.log(`2: ${city}`);
  } catch (err) {
    console.error(`2: ${err.message} ğŸ’¥`);
  }
  console.log('3: Finished getting location');
})();

///////////////////////////////////
//ìœ„ì™€ ê°™ì€ ì²˜ë¦¬(returnê³¼ throwì œì™¸)
const whereAmIOrigin = function () {
  getPosition()
    .then(pos => {
      const { latitude: lat, longitude: lng } = pos.coords;

      return fetch(`https://geocode.xyz/${lat},${lng}?geoit=json`);
    })
    .then(res => {
      if (!res.ok) throw new Error(`Problem with geocoding ${res.status}`);
      return res.json();
    })
    .then(data => {
      console.log(data);
      console.log(`You are in ${data.city}, ${data.country}`);

      return fetch(`https://restcountries.eu/rest/v2/name/${data.country}`);
    })
    .then(res => {
      if (!res.ok) throw new Error(`Country not found (${res.status})`);

      return res.json();
    })
    .then(data => renderCountry(data[0]))
    .catch(err => console.error(`${err.message} ğŸ’¥`));
};

whereAmIOrigin();
```

# Promises in Parallel

ì—¬ëŸ¬ promisesë“¤ì„ ë™ì‹œì— ì²˜ë¦¬ ì‹œí‚¤ëŠ” ë°©ë²•!

ì¦‰, Multi-Threading ë°©ë²•ì´ë‹¤.

Promise.allì˜ íŠ¹ì„± : ì—¬ëŸ¬ ì²˜ë¦¬ ì¤‘ í•˜ë‚˜ë¼ë„ rejectì´ë©´ ëª¨ë‘ rejectê°€ ë˜ì–´ returnëœë‹¤.

```javascript
const get3Countries = async function (c1, c2, c3) {
  try {
    // * awaitê°€ ê±¸ë ¤ìˆìœ¼ë¯€ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ ì§„í–‰
    // const [data1] = await getJSON(
    //   `https://restcountries.eu/rest/v2/name/${c1}`
    // );
    // const [data2] = await getJSON(
    //   `https://restcountries.eu/rest/v2/name/${c2}`
    // );
    // const [data3] = await getJSON(
    //   `https://restcountries.eu/rest/v2/name/${c3}`
    // );
    // console.log([data1.capital, data2.capital, data3.capital]);

    //Promise.allì„ í†µí•´ 3ê°œì˜ ì²˜ë¦¬ë¥¼ í•œêº¼ë²ˆì— ì§„í–‰
    const data = await Promise.all([
      getJSON(`https://restcountries.eu/rest/v2/name/${c1}`),
      getJSON(`https://restcountries.eu/rest/v2/name/${c2}`),
      getJSON(`https://restcountries.eu/rest/v2/name/${c3}`),
    ]);
    console.log(data.map(d => d[0].capital));
  } catch (err) {
    console.error(err);
  }
};
get3Countries('portugal', 'canada', 'tanzania');
```

## Other promises combinator: race, allSettled and any

all ì´ì™¸ì— Promiseë¥¼ ë™ì‹œì— ì§„í–‰ì‹œí‚¤ëŠ” Promiseì˜ static methodë¥¼ ì•Œì•„ë³´ì

Promise.raceëŠ” ì—¬ëŸ¬ê°œì˜ Primiseë¥¼ ë™ì‹œì— ì§„í–‰ì‹œì¼œ ë˜ëŠ”ëŒ€ë¡œ returnì‹œí‚¤ëŠ” methodë¡œ

ê·¸ íŠ¹ì„±ì„ ì´ìš©í•´ ì¼ì • ì‹œê°„ì„ ì´ˆê³¼í•˜ë©´ rejectí•˜ê²Œ ë” í•  ìˆ˜ ìˆë‹¤.

```javascript
// Promise.race
(async function () {
  const res = await Promise.race([
    getJSON(`https://restcountries.eu/rest/v2/name/italy`),
    getJSON(`https://restcountries.eu/rest/v2/name/egypt`),
    getJSON(`https://restcountries.eu/rest/v2/name/mexico`),
  ]);
  console.log(res[0]);
})();

const timeout = function (sec) {
  return new Promise(function (_, reject) {
    setTimeout(function () {
      reject(new Error('Request took too long!'));
    }, sec * 1000);
  });
};

// raceì˜ íŠ¹ì„±ì„ ì´ìš©í•œ ì‹œê°„ì´ˆ ì˜ˆì™¸ì²˜ë¦¬
// ë‚´ìš©:URLì„ ìš”ì²­í–ˆì„ë•Œ 5ì´ˆë³´ë‹¤ ë¹ ë¥´ë©´ fullfilled, ì•ˆë˜ë©´ timeoutìœ¼ë¡œ rejectedë¥¼ ë°˜í™˜
Promise.race([
  getJSON(`https://restcountries.eu/rest/v2/name/tanzania`),
  timeout(5),
])
  .then(res => console.log(res[0]))
  .catch(err => console.error(err));
```

Promise.allSettledëŠ” ES2020ì— ì¶”ê°€ëœ methodì´ë‹¤.

Promise.allê³¼ëŠ” ë‹¤ë¥´ê²Œ ë¬´ì¡°ê±´ fullfilled ìƒíƒœë¡œ returnëœë‹¤.

í•˜ì§€ë§Œ ê°ê° fullfilledì¸ì§€ rejectì¸ì§€ ì²˜ë¦¬ë³„ë¡œ ìƒíƒœëŠ” ì¨ì ¸ìˆë‹¤.

```javascript
// Promise.allSettled
// rejectê°€ ìˆì–´ë„ ëª¨ë‘ fullfilledë¡œ ë°˜í™˜ëœë‹¤.
Promise.allSettled([
  Promise.resolve('Success'),
  Promise.reject('ERROR'),
  Promise.resolve('Another success'),
]).then(res => console.log(res));

//ì²˜ë¦¬ ì¤‘ì— rejectê°€ ìˆìœ¼ë¯€ë¡œ catchëœë‹¤.
Promise.all([
  Promise.resolve('Success'),
  Promise.reject('ERROR'),
  Promise.resolve('Another success'),
])
  .then(res => console.log(res))
  .catch(err => console.error(err));
```

Promise.anyëŠ” ES2021ì— ì¶”ê°€ëœ methodì´ë‹¤.

rejectëœ ê²ƒì€ ë¬´ì‹œí•˜ê³  returní•˜ì—¬ ëª¨ë‘ fullfilledì´ë‹¤.

ëª¨ë“  ì²˜ë¦¬ê°€ rejectë©´ rejectë¥¼ ë°˜í™˜í•œë‹¤.

```javascript
// Promise.any [ES2021]
Promise.any([
  Promise.resolve('Success'),
  Promise.reject('ERROR'),
  Promise.resolve('Another success'),
])
  .then(res => console.log(res))
  .catch(err => console.error(err));
```